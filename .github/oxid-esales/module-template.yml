# {{ $ids := "oe_moduletemplate" }}ids: {{ print $ids }}
# {{ $org := "oxid-esales" }}organisation: {{ print $org }}
# {{ $name := "module-template" }}name: {{ print $name }}
# {{ $repo := "OXID-eSales/module-template" }}repo: {{ print $repo }}

install_shop_with_modules:
  git:
    shop_ref: '{{ .Data.global.git.default_ref }}'
  composer:
    transform: |
      {
          "preferred-install": {
            "oxid-esales/*": "source",
            "oxid-professional-services/*": "source",
            "ddoe/*": "source"
          },
          "require": {
              "oxid-esales/twig-component": "{{ .Data.global.composer.def_ref }}",
              "oxid-esales/twig-admin-theme": "{{ .Data.global.composer.def_ref }}",
              "oxid-esales/apex-theme": "{{ .Data.global.composer.def_ref }}",
              "{{ $org }}/${{ $name }}": "dev-{{ .Github.RefName }}"
          }
          "repositories": {
            "{{ $org }}/${{ $name }}": {
              "type": "git",
              "url": "https://github.com/{{ $repo }}.git"
            }
          }
      }

runscript:
  matrix:
    script: |
      [
        "tests-unit",
        "tests-integration",
        "tests-codeception",
        "phpcs-report",
        "phpmd-report",
        "phpstan-report"
      ]
  path: 'vendor/{{ $org}}/{{ $name }}'

sonarcloud:
  matrix:
    testplan: 'skip'
    # testplan: '["-"]'
  strip_path: '/var/www/dev-packages/{{ print $ids }}/'
  project_key: 'OXID-eSales_{{ print $name }}'
  project_name: '{{ $org}}/{{ $name }}'
  parameters: |
    -Dsonar.language=php
    -Dsonar.scm.provider=git
    -Dsonar.sources=src
    -Dsonar.tests=tests

finish:
  slack_title: '{{ print $name }} ({{ .Data.global.git.shop_ref }}) by {{ .Github.Actor }}'
